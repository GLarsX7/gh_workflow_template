name: Python CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"

jobs:
  # ==============================================================================
  # Check: Detect if this is a Python project
  # ==============================================================================
  detect:
    name: Detect Python Project
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      has_python: ${{ steps.check.outputs.has_python }}
      has_tests: ${{ steps.check.outputs.has_tests }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Check for Python files
        id: check
        run: |
          # Check if there are any Python files
          if find . -name "*.py" -type f | grep -q .; then
            echo "has_python=true" >> $GITHUB_OUTPUT
            echo "✅ Python files detected"
          else
            echo "has_python=false" >> $GITHUB_OUTPUT
            echo "⚠️ No Python files found - skipping Python CI"
          fi
          
          # Check if tests directory exists
          if [ -d "tests" ] || [ -d "test" ]; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
            echo "✅ Tests directory found"
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
            echo "⚠️ No tests directory found"
          fi

  # ==============================================================================
  # Quality: Code Formatting and Linting
  # ==============================================================================
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: detect
    if: needs.detect.outputs.has_python == 'true'
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            pyproject.toml
            requirements*.txt

      - name: Cache quality tools
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: quality-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('pyproject.toml') }}

      - name: Install tools
        run: |
          python -m pip install --upgrade pip
          pip install black isort ruff mypy

      - name: Format check (Black)
        run: |
          if find . -name "*.py" -type f | grep -q .; then
            black . --check --diff
          else
            echo "No Python files to check"
          fi

      - name: Import sort check (isort)
        run: |
          if find . -name "*.py" -type f | grep -q .; then
            isort . --check-only --diff
          else
            echo "No Python files to check"
          fi

      - name: Lint (Ruff)
        run: |
          if find . -name "*.py" -type f | grep -q .; then
            ruff check . --output-format=github
          else
            echo "No Python files to lint"
          fi

      - name: Type check (mypy)
        run: |
          if find . -name "*.py" -type f | grep -q .; then
            mypy . || echo "::warning::Type checking found issues or no files to check"
          else
            echo "No Python files to type check"
          fi

  # ==============================================================================
  # Security: Code and Dependency Scanning
  # ==============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: detect
    if: needs.detect.outputs.has_python == 'true'
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety pip-audit

      - name: Run Bandit security scan
        run: |
          if find . -name "*.py" -type f | grep -q .; then
            bandit -r . -f json -o bandit-report.json || echo "::warning::Bandit found security issues"
          else
            echo "No Python files to scan"
          fi

      - name: Run Safety dependency check
        run: |
          if [ -f requirements.txt ] || [ -f pyproject.toml ]; then
            safety check --json || echo "::warning::Safety found vulnerabilities"
          else
            echo "No requirements file found - skipping Safety check"
          fi

      - name: Run pip-audit
        run: |
          if [ -f requirements.txt ] || [ -f pyproject.toml ]; then
            pip-audit || echo "::warning::pip-audit found vulnerabilities"
          else
            echo "No requirements file found - skipping pip-audit"
          fi

      - name: Upload security artifacts
        if: always() && hashFiles('bandit-report.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
          retention-days: 30

  # ==============================================================================
  # Test: Unit and Integration Tests
  # ==============================================================================
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: detect
    if: needs.detect.outputs.has_python == 'true' && needs.detect.outputs.has_tests == 'true'
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: |
            pyproject.toml
            requirements*.txt

      - name: Cache test dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            .pytest_cache
          key: test-${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('pyproject.toml', 'requirements*.txt') }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-xdist coverage[toml]
          
          # Install project dependencies
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          
          # Install project in editable mode if setup exists
          if [ -f pyproject.toml ] && grep -q "\[build-system\]" pyproject.toml; then
            pip install -e .
          elif [ -f setup.py ]; then
            pip install -e .
          fi

      - name: Run tests with coverage
        run: |
          # Find tests directory (tests or test)
          TEST_DIR=""
          if [ -d "tests" ]; then
            TEST_DIR="tests"
          elif [ -d "test" ]; then
            TEST_DIR="test"
          fi
          
          if [ -z "$TEST_DIR" ]; then
            echo "::warning::No tests directory found - skipping tests"
            exit 0
          fi
          
          pytest "$TEST_DIR" \
            -v \
            --cov=. \
            --cov-report=xml \
            --cov-report=term-missing:skip-covered \
            --cov-branch \
            --junitxml=pytest-report.xml \
            -n auto \
            --maxfail=5

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.12' && hashFiles('coverage.xml') != ''
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: py${{ matrix.python-version }}
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload test artifacts
        if: matrix.python-version == '3.12' && hashFiles('coverage.xml') != ''
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.xml
            pytest-report.xml
          retention-days: 30

  # ==============================================================================
  # Build: Package Build and Validation
  # ==============================================================================
  build:
    name: Build & Validate Package
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [detect, quality, security]
    if: needs.detect.outputs.has_python == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine check-wheel-contents

      - name: Build package
        run: |
          if [ -f pyproject.toml ] || [ -f setup.py ]; then
            python -m build
          else
            echo "::warning::No pyproject.toml or setup.py found. Skipping build."
            exit 0
          fi

      - name: Validate package
        if: hashFiles('dist/*') != ''
        run: |
          twine check dist/*
          if ls dist/*.whl 1> /dev/null 2>&1; then
            check-wheel-contents dist/*.whl
          fi

      - name: Upload package artifacts
        if: hashFiles('dist/*') != ''
        uses: actions/upload-artifact@v4
        with:
          name: python-package-distributions
          path: dist/
          retention-days: 30

  # ==============================================================================
  # SBOM: Software Bill of Materials (Optional)
  # ==============================================================================
  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [detect, build]
    if: needs.detect.outputs.has_python == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Generate SBOM
        run: |
          pip install cyclonedx-bom
          cyclonedx-py environment --outfile sbom.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json
          retention-days: 90

  # ==============================================================================
  # Status Gate: Final Pipeline Validation
  # ==============================================================================
  status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [detect, quality, security, test, build]
    if: always()

    steps:
      - name: Check if Python project
        if: needs.detect.outputs.has_python != 'true'
        run: |
          echo "⚠️ No Python files detected - CI pipeline skipped"
          echo "This is normal for non-Python projects or template repositories"
          exit 0

      - name: Check required jobs
        if: needs.detect.outputs.has_python == 'true'
        run: |
          results=(
            "${{ needs.quality.result }}"
            "${{ needs.security.result }}"
          )
          
          # Test job is optional (only runs if tests exist)
          if [ "${{ needs.detect.outputs.has_tests }}" == "true" ]; then
            results+=("${{ needs.test.result }}")
          fi
          
          # Build job is optional (only runs if setup files exist)
          if [ "${{ needs.build.result }}" != "skipped" ]; then
            results+=("${{ needs.build.result }}")
          fi
          
          failed=false
          for result in "${results[@]}"; do
            if [[ "$result" != "success" && "$result" != "skipped" ]]; then
              echo "::error::Pipeline failed. Job result: $result"
              failed=true
            fi
          done
          
          if [ "$failed" = true ]; then
            exit 1
          fi
          
          echo "✅ All required checks passed"